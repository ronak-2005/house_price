<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Titanic Survival Predictor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10">

  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-2xl">
    <h1 class="text-3xl font-bold text-center text-indigo-600 mb-6">
      ðŸš¢ Titanic Survival Batch Prediction
    </h1>

    <!-- Upload Form -->
    <form id="csvForm" class="flex flex-col items-center space-y-4" 
          action="/predict_csv" method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept=".csv" required 
             class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                    file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600
                    hover:file:bg-indigo-100">
      <button type="submit" 
              class="px-6 py-2 bg-indigo-600 text-white rounded-xl shadow hover:bg-indigo-700 transition">
        Upload & Predict
      </button>
    </form>

    <!-- Results Section -->
    <div id="results" class="mt-8 hidden">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Prediction Results (Top 10)</h2>
      <div class="overflow-x-auto rounded-xl shadow">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="bg-indigo-100 text-indigo-700">
            <tr id="results-head"></tr>
          </thead>
          <tbody id="results-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <!-- Download button -->
      <div class="flex justify-end mt-4">
        <button id="downloadBtn" 
                class="px-5 py-2 bg-green-500 text-white rounded-xl shadow hover:bg-green-600 transition">
          Download CSV
        </button>
      </div>
    </div>
  </div>

  <script>
    let allPredictions = [];

    document.getElementById("csvForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const formData = new FormData();
      formData.append("file", e.target.file.files[0]);

      const response = await fetch("/predict_csv", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      allPredictions = data.predictions;

      // show only first 10
      const displayData = data.predictions.slice(0, 10);

      // Build header dynamically
      let headHtml = "";
      for (const key in displayData[0]) {
        headHtml += `<th class="px-4 py-2">${key}</th>`;
      }
      document.getElementById("results-head").innerHTML = headHtml;

      // Build rows
      let bodyHtml = "";
      displayData.forEach(row => {
        bodyHtml += "<tr class='hover:bg-indigo-50 transition'>";
        for (const key in row) {
          bodyHtml += `<td class="px-4 py-2">${row[key]}</td>`;
        }
        bodyHtml += "</tr>";
      });
      document.getElementById("results-body").innerHTML = bodyHtml;

      document.getElementById("results").classList.remove("hidden");
    });

    // Download CSV button
    document.getElementById("downloadBtn").addEventListener("click", function() {
      if (allPredictions.length === 0) return;

      let csv = Object.keys(allPredictions[0]).join(",") + "\n";
      allPredictions.forEach(row => {
        csv += Object.values(row).join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      saveAs(blob, "predictions.csv");
    });
  </script>
</body>
</html>
